<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes, viewport-fit=cover">
    <title>عيادة الدكتورة ميساء ميسر ناصر</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Cairo', sans-serif;
        }

        body {
            background: #f5f5f5;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0;
            margin: 0;
        }

        .app-container {
            max-width: 450px;
            width: 100%;
            background: white;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            position: relative;
            box-shadow: 0 0 30px rgba(0,0,0,0.1);
        }

        .header {
            background: linear-gradient(135deg, #6B73FF 0%, #000DFF 100%);
            color: white;
            padding: 30px 20px 30px;
            text-align: center;
            border-bottom-left-radius: 30px;
            border-bottom-right-radius: 30px;
            position: relative;
        }

        .clinic-name h1 {
            font-size: 22px;
            margin-bottom: 5px;
            font-weight: 700;
        }

        .clinic-name p {
            font-size: 14px;
            opacity: 0.9;
        }

        .header-decoration {
            position: absolute;
            bottom: -10px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: center;
            gap: 10px;
        }

        .decoration-dot {
            width: 8px;
            height: 8px;
            background: rgba(255,255,255,0.5);
            border-radius: 50%;
        }

        /* Safe Area for devices with notches and system buttons */
        .safe-area {
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
            padding-left: env(safe-area-inset-left);
            padding-right: env(safe-area-inset-right);
        }

        /* Main Content Area - Scrollable */
        .main-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #f8f9fe;
            scroll-behavior: smooth;
        }

        /* Bottom Navigation - مع مراعاة أزرار النظام */
        .bottom-nav {
            background: white;
            border-top: 1px solid #e0e0e0;
            padding: 10px 20px;
            padding-bottom: calc(10px + env(safe-area-inset-bottom, 0px));
            display: none;
            justify-content: space-around;
            align-items: center;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.05);
            position: relative;
            z-index: 10;
        }

        /* إضافة مساحة إضافية للأجهزة التي تحتوي على أزرار تنقل */
        @supports (padding-bottom: env(safe-area-inset-bottom)) {
            .bottom-nav {
                padding-bottom: max(10px, env(safe-area-inset-bottom));
            }
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: #999;
            font-size: 12px;
            transition: all 0.3s;
            cursor: pointer;
            padding: 5px 15px;
            border-radius: 20px;
        }

        .nav-item i {
            font-size: 22px;
            margin-bottom: 3px;
        }

        .nav-item.active {
            color: #6B73FF;
            background: rgba(107, 115, 255, 0.1);
        }

        .nav-item span {
            font-weight: 600;
        }

        /* Cards and Sections */
        .section-card {
            background: white;
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.03);
            border: 1px solid rgba(107, 115, 255, 0.1);
        }

        .section-title {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .section-title h3 {
            color: #333;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-title h3 i {
            color: #6B73FF;
        }

        .view-all {
            color: #6B73FF;
            font-size: 14px;
            font-weight: 600;
            text-decoration: none;
        }

        /* Notification Bar */
        .notification-bar {
            background: #fff3cd;
            color: #856404;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-radius: 15px;
            margin-bottom: 20px;
            cursor: pointer;
            transition: all 0.3s;
            border: 1px solid #ffeeba;
        }

        .notification-bar:hover {
            background: #ffe8a1;
        }

        .notification-content {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .notification-badge {
            background: #dc3545;
            color: white;
            border-radius: 50%;
            padding: 2px 8px;
            font-size: 12px;
            margin-right: 10px;
        }

        /* Notifications Panel */
        .notifications-panel {
            background: white;
            border-radius: 15px;
            margin-bottom: 20px;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            border: 1px solid #e0e0e0;
        }

        .notifications-panel.show {
            max-height: 300px;
            overflow-y: auto;
        }

        .notification-item {
            padding: 15px 20px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            align-items: center;
            gap: 15px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .notification-item:hover {
            background: #f8f9fa;
        }

        .notification-item.unread {
            background: #e8f4fd;
        }

        .notification-icon {
            width: 40px;
            height: 40px;
            background: #6B73FF;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .notification-details {
            flex: 1;
        }

        .notification-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .notification-time {
            font-size: 12px;
            color: #999;
        }

        .notification-desc {
            font-size: 13px;
            color: #666;
        }

        /* Login Section */
        .login-card {
            text-align: center;
            padding: 20px 0;
        }

        .doctor-icon {
            font-size: 80px;
            color: #6B73FF;
            margin-bottom: 20px;
            background: rgba(107, 115, 255, 0.1);
            width: 120px;
            height: 120px;
            line-height: 120px;
            border-radius: 60px;
            margin: 0 auto 20px;
        }

        .login-card h2 {
            color: #333;
            margin-bottom: 10px;
            font-size: 24px;
        }

        .login-card p {
            color: #666;
            margin-bottom: 30px;
        }

        .input-group {
            position: relative;
            margin-bottom: 20px;
        }

        .input-group i {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #999;
        }

        .input-group input {
            width: 100%;
            padding: 15px 45px 15px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 15px;
            font-size: 16px;
            transition: all 0.3s;
            background: #f8f9fa;
        }

        .input-group input:focus {
            border-color: #6B73FF;
            outline: none;
            background: white;
        }

        .login-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #6B73FF 0%, #000DFF 100%);
            color: white;
            border: none;
            border-radius: 15px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 5px 15px rgba(107, 115, 255, 0.3);
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(107, 115, 255, 0.4);
        }

        .info-note {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            color: #666;
            font-size: 14px;
            border: 1px solid #e0e0e0;
        }

        .info-note i {
            color: #6B73FF;
            margin-left: 5px;
        }

        /* Registration Section */
        .registration-section {
            padding: 0;
        }

        .form-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            background: white;
            padding: 15px 20px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.03);
        }

        .back-btn {
            background: none;
            border: none;
            font-size: 24px;
            color: #6B73FF;
            cursor: pointer;
            margin-left: 15px;
            width: 40px;
            height: 40px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(107, 115, 255, 0.1);
        }

        .form-header h2 {
            color: #333;
            font-size: 20px;
        }

        .form-section {
            background: white;
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(107, 115, 255, 0.1);
        }

        .form-section h3 {
            color: #6B73FF;
            margin-bottom: 20px;
            font-size: 18px;
            display: flex;
            align-items: center;
        }

        .form-section h3 i {
            margin-left: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 600;
            font-size: 14px;
        }

        .form-group input[type="text"],
        .form-group input[type="number"],
        .form-group input[type="date"],
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 14px;
            transition: all 0.3s;
            background: #f8f9fa;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            border-color: #6B73FF;
            outline: none;
            background: white;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .radio-group {
            display: flex;
            gap: 20px;
            margin-top: 5px;
        }

        .radio-group label {
            display: flex;
            align-items: center;
            font-weight: normal;
        }

        .radio-group input[type="radio"] {
            margin-left: 5px;
        }

        .multi-select {
            height: 100px;
        }

        .readonly-field {
            background-color: #f0f0f0;
            cursor: not-allowed;
        }

        .form-actions {
            margin-top: 30px;
            margin-bottom: 20px;
        }

        .save-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #00b09b, #96c93d);
            color: white;
            border: none;
            border-radius: 15px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 5px 15px rgba(0, 176, 155, 0.3);
        }

        .save-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 176, 155, 0.4);
        }

        small {
            color: #999;
            font-size: 12px;
            margin-top: 5px;
            display: block;
        }

        /* Dashboard Section */
        .dashboard-section {
            padding: 0;
        }

        .welcome-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 20px;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
        }

        .welcome-card::before {
            content: "✿";
            position: absolute;
            bottom: -20px;
            right: -20px;
            font-size: 120px;
            opacity: 0.1;
            color: white;
        }

        .welcome-card h2 {
            font-size: 22px;
            margin-bottom: 5px;
        }

        .info-card {
            background: white;
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(107, 115, 255, 0.1);
        }

        .info-card h3 {
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }

        .info-card h3 i {
            color: #6B73FF;
            margin-left: 10px;
        }

        .info-row {
            display: flex;
            margin-bottom: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .info-label {
            font-weight: 600;
            width: 40%;
            color: #666;
        }

        .info-value {
            width: 60%;
            color: #333;
        }

        .appointments-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .appointment-item {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 10px;
            border-right: 4px solid #6B73FF;
        }

        .appointment-date {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .appointment-time {
            color: #666;
            font-size: 14px;
        }

        .appointment-status {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            margin-top: 5px;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-confirmed {
            background: #d4edda;
            color: #155724;
        }

        .status-completed {
            background: #cce5ff;
            color: #004085;
        }

        .book-btn, .history-btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 15px;
            transition: all 0.3s;
        }

        .book-btn {
            background: linear-gradient(135deg, #6B73FF 0%, #000DFF 100%);
            color: white;
            box-shadow: 0 5px 15px rgba(107, 115, 255, 0.3);
        }

        .history-btn {
            background: linear-gradient(135deg, #FF6B6B 0%, #FF0000 100%);
            color: white;
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.3);
        }

        .logout-btn {
            width: 100%;
            padding: 12px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
        }

        /* Loading Spinner */
        .loading-spinner {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 30px;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #6B73FF;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Alert Messages */
        .alert {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
            animation: slideDown 0.3s ease;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        /* Thank You Message - Center Popup */
        .thank-you-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .thank-you-message {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            max-width: 300px;
            animation: popIn 0.5s ease;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        }

        .thank-you-message i {
            font-size: 60px;
            margin-bottom: 15px;
        }

        .thank-you-message h3 {
            font-size: 22px;
            margin-bottom: 10px;
        }

        .thank-you-message p {
            font-size: 16px;
            opacity: 0.9;
        }

        /* رسالة تأكيد الحجز في المنتصف */
        .booking-confirm-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .booking-confirm-message {
            background: linear-gradient(135deg, #6B73FF 0%, #000DFF 100%);
            color: white;
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            max-width: 300px;
            animation: popIn 0.5s ease;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        }

        .booking-confirm-message i {
            font-size: 60px;
            margin-bottom: 15px;
        }

        .booking-confirm-message h3 {
            font-size: 22px;
            margin-bottom: 10px;
        }

        .booking-confirm-message p {
            font-size: 16px;
            opacity: 0.9;
        }

        @keyframes slideDown {
            from {
                transform: translateY(-20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes popIn {
            from {
                transform: scale(0.5);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* Appointments Grid */
        .appointments-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .appointment-slot {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .appointment-slot:hover {
            border-color: #6B73FF;
            transform: scale(1.05);
        }

        .appointment-slot.selected {
            background: #6B73FF;
            color: white;
            border-color: #6B73FF;
        }

        .appointment-slot.selected .slot-time {
            color: white;
        }

        .appointment-slot.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .appointment-slot.booked {
            background: #d4edda;
            border-color: #28a745;
            cursor: not-allowed;
            opacity: 0.7;
        }

        .appointment-slot.booked .slot-time {
            color: #155724;
        }

        .appointment-slot.full {
            background: #f8d7da;
            border-color: #dc3545;
            cursor: not-allowed;
            opacity: 0.7;
        }

        .appointment-slot.full .slot-time {
            color: #721c24;
        }

        .full-label {
            font-size: 11px;
            color: #dc3545;
            font-weight: bold;
            margin-top: 5px;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
            padding: 20px;
            padding-bottom: calc(20px + env(safe-area-inset-bottom, 0px));
        }

        .modal-content {
            background: white;
            border-radius: 25px;
            padding: 25px;
            max-width: 400px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease;
            margin-bottom: env(safe-area-inset-bottom, 0px);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h3 {
            color: #333;
            font-size: 20px;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            color: #999;
            cursor: pointer;
        }

        @keyframes slideUp {
            from {
                transform: translateY(50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* قائمة الحجز المنبثقة - مع مراعاة أزرار النظام */
        .booking-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top-left-radius: 30px;
            border-top-right-radius: 30px;
            padding: 20px;
            padding-bottom: calc(20px + env(safe-area-inset-bottom, 0px));
            box-shadow: 0 -5px 30px rgba(0,0,0,0.2);
            transform: translateY(100%);
            transition: transform 0.3s ease;
            z-index: 200;
            max-height: 70vh;
            overflow-y: auto;
        }

        .booking-panel.show {
            transform: translateY(0);
        }

        .booking-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .booking-panel-header h3 {
            color: #333;
            font-size: 20px;
        }

        .close-booking {
            background: none;
            border: none;
            font-size: 24px;
            color: #999;
            cursor: pointer;
        }

        .booking-panel-content {
            margin-bottom: 20px;
        }

        .booking-panel-footer {
            display: flex;
            gap: 10px;
            margin-bottom: env(safe-area-inset-bottom, 0px);
        }

        .booking-panel-footer button {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }

        .booking-confirm-btn {
            background: linear-gradient(135deg, #6B73FF 0%, #000DFF 100%);
            color: white;
        }

        .booking-cancel-btn {
            background: #f0f0f0;
            color: #666;
        }

        /* تحسين المسافات للأجهزة ذات الشاشات الطويلة */
        @media (min-height: 700px) {
            .main-content {
                padding-bottom: 30px;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="header">
            <div class="clinic-name">
                <h1>عيادة الدكتورة ميساء ميسر ناصر</h1>
                <p>نسأل الله لك الشفاء والعافية</p>
            </div>
            <div class="header-decoration">
                <span class="decoration-dot"></span>
                <span class="decoration-dot"></span>
                <span class="decoration-dot"></span>
            </div>
        </div>

        <!-- Alert Messages -->
        <div id="alertMessage" class="alert" style="display: none;"></div>

        <!-- Thank You Overlay for Registration -->
        <div id="thankYouOverlay" class="thank-you-overlay">
            <div class="thank-you-message">
                <i class="fas fa-check-circle"></i>
                <h3>تم حفظ البيانات!</h3>
                <p>شكراً لك، تم حفظ بياناتك بنجاح</p>
            </div>
        </div>

        <!-- Booking Confirmation Overlay -->
        <div id="bookingConfirmOverlay" class="booking-confirm-overlay">
            <div class="booking-confirm-message">
                <i class="fas fa-calendar-check"></i>
                <h3>تم حجز الموعد!</h3>
                <p>تم حجز موعدك بنجاح</p>
            </div>
        </div>

        <!-- Modal for Previous Appointments -->
        <div id="historyModal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header">
                    <h3><i class="fas fa-history"></i> المواعيد السابقة</h3>
                    <button class="close-modal" onclick="closeHistoryModal()">&times;</button>
                </div>
                <div id="previousAppointmentsList" class="appointments-list">
                    <!-- سيتم تعبئتها عبر JavaScript -->
                </div>
            </div>
        </div>

        <!-- Booking Panel (يظهر عند الضغط على زر الحجز) -->
        <div id="bookingPanel" class="booking-panel">
            <div class="booking-panel-header">
                <h3><i class="fas fa-calendar-alt"></i> حجز موعد</h3>
                <button class="close-booking" onclick="hideBookingPanel()">&times;</button>
            </div>
            <div class="booking-panel-content">
                <div id="availableAppointmentsPanel" class="appointments-grid">
                    <div class="loading-spinner">
                        <div class="spinner"></div>
                    </div>
                </div>
            </div>
            <div class="booking-panel-footer">
                <button class="booking-confirm-btn" onclick="confirmBooking()">تأكيد الحجز</button>
                <button class="booking-cancel-btn" onclick="hideBookingPanel()">إلغاء</button>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="main-content" id="mainContent">
            <!-- Notification Bar -->
            <div id="notificationBar" class="notification-bar" onclick="toggleNotifications()" style="display: none;">
                <div class="notification-content">
                    <i class="fas fa-bell"></i>
                    <span>لديك إشعارات جديدة</span>
                    <span id="notificationCount" class="notification-badge">0</span>
                </div>
                <i class="fas fa-chevron-down"></i>
            </div>

            <!-- Notifications Panel -->
            <div id="notificationsPanel" class="notifications-panel"></div>

            <!-- Login Section -->
            <div class="login-section" id="loginSection">
                <div class="login-card">
                    <div class="doctor-icon">
                        <i class="fas fa-user-md"></i>
                    </div>
                    <h2>تسجيل الدخول</h2>
                    <p>الرجاء إدخال الاسم الثلاثي</p>
                    
                    <div class="input-group">
                        <i class="fas fa-user"></i>
                        <input type="text" id="fullName" placeholder="الاسم الثلاثي (مثال: مريم أحمد محمد)" autocomplete="off">
                    </div>
                    
                    <button onclick="checkUser()" class="login-btn">
                        <i class="fas fa-sign-in-alt"></i>
                        دخول
                    </button>
                    
                    <div class="info-note">
                        <i class="fas fa-info-circle"></i>
                        <span>إذا كانت هذه زيارتك الأولى، سيتم توجيهك لتعبئة البيانات</span>
                    </div>
                </div>
            </div>

            <!-- Registration Section -->
            <div class="registration-section" id="registrationSection" style="display: none;">
                <div class="form-header">
                    <button onclick="showLogin()" class="back-btn">
                        <i class="fas fa-arrow-right"></i>
                    </button>
                    <h2>تعبئة بيانات المريضة</h2>
                </div>
                
                <form id="patientForm" onsubmit="savePatientData(event)">
                    <div class="form-section">
                        <h3><i class="fas fa-user-circle"></i> المعلومات الشخصية</h3>
                        
                        <div class="form-group">
                            <label>الاسم الثلاثي:</label>
                            <input type="text" id="regFullName" readonly class="readonly-field">
                        </div>
                        
                        <div class="form-group">
                            <label>العمر:</label>
                            <input type="number" id="age" required min="15" max="60">
                        </div>
                        
                        <div class="form-group">
                            <label>مكان السكن:</label>
                            <input type="text" id="address" required>
                        </div>
                        
                        <div class="form-group">
                            <label>فصيلة الدم:</label>
                            <select id="bloodType" required>
                                <option value="">اختر فصيلة الدم</option>
                                <option value="A+">A+</option>
                                <option value="A-">A-</option>
                                <option value="B+">B+</option>
                                <option value="B-">B-</option>
                                <option value="AB+">AB+</option>
                                <option value="AB-">AB-</option>
                                <option value="O+">O+</option>
                                <option value="O-">O-</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>هل يوجد اختلاف في فصيلة الدم بينك وبين زوجك؟</label>
                            <div class="radio-group">
                                <label><input type="radio" name="bloodDiff" value="yes" required> نعم</label>
                                <label><input type="radio" name="bloodDiff" value="no"> لا</label>
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3><i class="fas fa-heartbeat"></i> الحالة الصحية</h3>
                        
                        <div class="form-group">
                            <label>هل لديك أمراض مزمنة؟</label>
                            <select id="chronicDiseases" multiple class="multi-select">
                                <option value="سكري">سكري</option>
                                <option value="ضغط الدم">ضغط الدم</option>
                                <option value="أمراض القلب">أمراض القلب</option>
                                <option value="أمراض الغدة الدرقية">أمراض الغدة الدرقية</option>
                                <option value="ربو">ربو</option>
                                <option value="أخرى">أخرى</option>
                            </select>
                            <small>يمكنك اختيار أكثر من خيار (اضغط Ctrl للاختيار المتعدد)</small>
                        </div>
                        
                        <div class="form-group">
                            <label>حساسية من أدوية معينة:</label>
                            <select id="drugAllergy" multiple class="multi-select">
                                <option value="بنسلين">بنسلين</option>
                                <option value="مضادات حيوية">مضادات حيوية</option>
                                <option value="أسبرين">أسبرين</option>
                                <option value="مضادات التهاب">مضادات التهاب</option>
                                <option value="أخرى">أخرى</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>هل أجريت عمليات سابقة؟</label>
                            <div class="radio-group">
                                <label><input type="radio" name="surgeries" value="yes" onchange="toggleSurgeriesDetail(true)"> نعم</label>
                                <label><input type="radio" name="surgeries" value="no" onchange="toggleSurgeriesDetail(false)" checked> لا</label>
                            </div>
                            <div id="surgeriesDetail" style="display: none;">
                                <textarea id="surgeriesDetails" placeholder="اذكري تفاصيل العمليات السابقة"></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3><i class="fas fa-baby"></i> معلومات الحمل والأطفال</h3>
                        
                        <div class="form-group">
                            <label>كم طفل لديك؟</label>
                            <input type="number" id="childrenCount" min="0" value="0">
                        </div>
                        
                        <div class="form-group">
                            <label>هل تعرضتي لإسقاط سابق؟</label>
                            <div class="radio-group">
                                <label><input type="radio" name="miscarriage" value="yes" onchange="toggleMiscarriageDetail(true)"> نعم</label>
                                <label><input type="radio" name="miscarriage" value="no" onchange="toggleMiscarriageDetail(false)" checked> لا</label>
                            </div>
                            <div id="miscarriageDetail" style="display: none;">
                                <textarea id="miscarriageReason" placeholder="سبب الإسقاط"></textarea>
                                <div style="margin-top: 10px;">
                                    <label>هل الأطفال متوفين؟</label>
                                    <div class="radio-group">
                                        <label><input type="radio" name="childrenAlive" value="yes"> نعم</label>
                                        <label><input type="radio" name="childrenAlive" value="no"> لا</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>نوع الحمل السابق:</label>
                            <select id="conceptionType">
                                <option value="natural">طبيعي</option>
                                <option value="assisted">بمساعدة (تلقيح صناعي/أطفال أنابيب)</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>الأعراض التي عانيتيها في الحمل السابق:</label>
                            <select id="pregnancySymptoms" multiple class="multi-select" onchange="checkOtherSymptoms()">
                                <option value="ضغط الحمل">ضغط الحمل</option>
                                <option value="سكر الحمل">سكر الحمل</option>
                                <option value="تخثر الدم">تخثر الدم</option>
                                <option value="غثيان شديد">غثيان شديد</option>
                                <option value="أخرى">أخرى</option>
                            </select>
                            <div id="otherSymptomsDiv" style="display: none; margin-top: 10px;">
                                <textarea id="otherSymptoms" placeholder="اذكري الأعراض الأخرى"></textarea>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>العلاجات التي استخدمتيها سابقاً:</label>
                            <textarea id="previousTreatments" rows="3"></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label>هل أنت مدخنة؟</label>
                            <div class="radio-group">
                                <label><input type="radio" name="smoker" value="yes"> نعم</label>
                                <label><input type="radio" name="smoker" value="no" checked> لا</label>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>تاريخ آخر دورة شهرية:</label>
                            <input type="date" id="lastPeriod" required>
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="submit" class="save-btn">
                            <i class="fas fa-save"></i>
                            حفظ البيانات
                        </button>
                    </div>
                </form>
            </div>

            <!-- Dashboard Section -->
            <div class="dashboard-section" id="dashboardSection" style="display: none;">
                <div id="dashboardContent"></div>
            </div>
        </div>

        <!-- Bottom Navigation -->
        <div class="bottom-nav" id="bottomNav" style="display: none;">
            <div class="nav-item active" onclick="showHomeTab()">
                <i class="fas fa-home"></i>
                <span>الرئيسية</span>
            </div>
            <div class="nav-item" onclick="showBookingPanel()">
                <i class="fas fa-calendar-plus"></i>
                <span>حجز</span>
            </div>
            <div class="nav-item" onclick="showPreviousAppointments()">
                <i class="fas fa-history"></i>
                <span>السابقة</span>
            </div>
            <div class="nav-item" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i>
                <span>خروج</span>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // استيراد مكتبات Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, set, get, child, push, update, onValue, off } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-analytics.js";

        // إعداد Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyB-Lfs7URKHaMRbouKUd-E3moKec1MQs8U",
            authDomain: "saha-f176d.firebaseapp.com",
            databaseURL: "https://saha-f176d-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "saha-f176d",
            storageBucket: "saha-f176d.firebasestorage.app",
            messagingSenderId: "304950545831",
            appId: "1:304950545831:web:5a3ce2906078f71a38ba82",
            measurementId: "G-NGQ29HZRE8"
        };

        // تهيئة Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const database = getDatabase(app);

        // متغيرات عامة
        let currentUser = null;
        let notificationsRef = null;
        let notificationsListener = null;
        let selectedAppointment = null;

        // دالة عرض الرسائل
        window.showAlert = function(message, type) {
            const alertDiv = document.getElementById('alertMessage');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            alertDiv.style.display = 'block';
            
            setTimeout(() => {
                alertDiv.style.display = 'none';
            }, 3000);
        };

        // دالة عرض رسالة الشكر في الوسط للتسجيل
        window.showThankYouMessage = function() {
            const overlay = document.getElementById('thankYouOverlay');
            overlay.style.display = 'flex';
            
            setTimeout(() => {
                overlay.style.display = 'none';
            }, 2000);
        };

        // دالة عرض رسالة تأكيد الحجز في الوسط
        window.showBookingConfirmMessage = function() {
            const overlay = document.getElementById('bookingConfirmOverlay');
            overlay.style.display = 'flex';
            
            setTimeout(() => {
                overlay.style.display = 'none';
            }, 2000);
        };

        // دالة إظهار لوحة الحجز
        window.showBookingPanel = function() {
            if (!currentUser) return;
            document.getElementById('bookingPanel').classList.add('show');
            loadAvailableAppointmentsPanel();
            
            // تحديث التنشيط في القائمة السفلية
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            document.querySelectorAll('.nav-item')[1].classList.add('active');
        };

        // دالة إخفاء لوحة الحجز
        window.hideBookingPanel = function() {
            document.getElementById('bookingPanel').classList.remove('show');
        };

        // دالة عرض الصفحة الرئيسية
        window.showHomeTab = function() {
            // تحديث التنشيط في القائمة السفلية
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            event.currentTarget.classList.add('active');
            
            // العودة إلى أعلى الصفحة
            document.querySelector('.main-content').scrollTop = 0;
            
            // إخفاء لوحة الحجز إذا كانت مفتوحة
            hideBookingPanel();
        };

        // دالة التحقق من المستخدم
        window.checkUser = async function() {
            const fullName = document.getElementById('fullName').value.trim();
            
            if (!fullName) {
                showAlert('الرجاء إدخال الاسم الثلاثي', 'error');
                return;
            }

            // التحقق من وجود المستخدم في قاعدة البيانات
            const dbRef = ref(database);
            try {
                const snapshot = await get(child(dbRef, `patients/${fullName.replace(/\./g, '_')}`));
                
                if (snapshot.exists()) {
                    // المستخدم موجود - الانتقال إلى لوحة التحكم
                    currentUser = snapshot.val();
                    currentUser.fullName = fullName;
                    showDashboard();
                } else {
                    // مستخدم جديد - الانتقال إلى صفحة التسجيل
                    document.getElementById('regFullName').value = fullName;
                    document.getElementById('loginSection').style.display = 'none';
                    document.getElementById('registrationSection').style.display = 'block';
                }
            } catch (error) {
                console.error('Error checking user:', error);
                showAlert('حدث خطأ في التحقق من البيانات', 'error');
            }
        };

        // دالة عرض صفحة تسجيل الدخول
        window.showLogin = function() {
            document.getElementById('registrationSection').style.display = 'none';
            document.getElementById('dashboardSection').style.display = 'none';
            document.getElementById('loginSection').style.display = 'block';
            document.getElementById('bottomNav').style.display = 'none';
            document.getElementById('bookingPanel').classList.remove('show');
            
            // إيقاف الاستماع للإشعارات
            if (notificationsListener) {
                off(notificationsRef);
            }
        };

        // دوال إظهار/إخفاء التفاصيل
        window.toggleSurgeriesDetail = function(show) {
            document.getElementById('surgeriesDetail').style.display = show ? 'block' : 'none';
        };

        window.toggleMiscarriageDetail = function(show) {
            document.getElementById('miscarriageDetail').style.display = show ? 'block' : 'none';
        };

        window.checkOtherSymptoms = function() {
            const select = document.getElementById('pregnancySymptoms');
            const selectedOptions = Array.from(select.selectedOptions).map(opt => opt.value);
            document.getElementById('otherSymptomsDiv').style.display = selectedOptions.includes('أخرى') ? 'block' : 'none';
        };

        // دالة حفظ بيانات المريض
        window.savePatientData = async function(event) {
            event.preventDefault();

            const fullName = document.getElementById('regFullName').value;
            
            // جمع البيانات من النموذج
            const patientData = {
                fullName: fullName,
                age: document.getElementById('age').value,
                address: document.getElementById('address').value,
                bloodType: document.getElementById('bloodType').value,
                bloodTypeDifference: document.querySelector('input[name="bloodDiff"]:checked')?.value || '',
                chronicDiseases: Array.from(document.getElementById('chronicDiseases').selectedOptions).map(opt => opt.value),
                drugAllergy: Array.from(document.getElementById('drugAllergy').selectedOptions).map(opt => opt.value),
                previousSurgeries: document.querySelector('input[name="surgeries"]:checked')?.value || 'no',
                surgeriesDetails: document.getElementById('surgeriesDetails')?.value || '',
                numberOfChildren: document.getElementById('childrenCount').value,
                miscarriages: document.querySelector('input[name="miscarriage"]:checked')?.value || 'no',
                miscarriageReason: document.getElementById('miscarriageReason')?.value || '',
                childrenAlive: document.querySelector('input[name="childrenAlive"]:checked')?.value || '',
                conceptionType: document.getElementById('conceptionType').value,
                pregnancySymptoms: Array.from(document.getElementById('pregnancySymptoms').selectedOptions).map(opt => opt.value),
                otherSymptoms: document.getElementById('otherSymptoms')?.value || '',
                previousTreatments: document.getElementById('previousTreatments').value,
                smoker: document.querySelector('input[name="smoker"]:checked')?.value || 'no',
                lastPeriod: document.getElementById('lastPeriod').value,
                registrationDate: new Date().toISOString(),
                registrationComplete: true
            };

            // حفظ في Firebase
            try {
                const patientRef = ref(database, `patients/${fullName.replace(/\./g, '_')}`);
                await set(patientRef, patientData);
                
                // حفظ نسخة في قائمة المرضى للوحة التحكم
                const patientsListRef = ref(database, 'patientsList');
                await push(patientsListRef, {
                    fullName: fullName,
                    registrationDate: new Date().toISOString()
                });

                // عرض رسالة "تم حفض بياناتك" في الوسط
                showThankYouMessage();
                
                // الانتقال إلى لوحة التحكم بعد ثانية
                setTimeout(() => {
                    currentUser = patientData;
                    showDashboard();
                }, 1500);
            } catch (error) {
                console.error('Error saving data:', error);
                showAlert('حدث خطأ في حفظ البيانات', 'error');
            }
        };

        // دالة عرض لوحة التحكم
        window.showDashboard = async function() {
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('registrationSection').style.display = 'none';
            document.getElementById('dashboardSection').style.display = 'block';
            document.getElementById('bottomNav').style.display = 'flex';
            
            // تفعيل زر الرئيسية في القائمة السفلية
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            document.querySelectorAll('.nav-item')[0].classList.add('active');
            
            // إظهار شريط الإشعارات
            document.getElementById('notificationBar').style.display = 'flex';

            const dashboardContent = document.getElementById('dashboardContent');
            
            // عرض معلومات المريض مع الاسم بشكل صحيح
            dashboardContent.innerHTML = `
                <div class="welcome-card">
                    <h2>مرحباً ${currentUser.fullName}</h2>
                    <p>نتمنى لك دوام الصحة والعافية</p>
                </div>

                <div class="info-card">
                    <h3><i class="fas fa-user"></i> معلوماتك الشخصية</h3>
                    <div class="info-row">
                        <span class="info-label">الاسم:</span>
                        <span class="info-value">${currentUser.fullName}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">العمر:</span>
                        <span class="info-value">${currentUser.age} سنة</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">مكان السكن:</span>
                        <span class="info-value">${currentUser.address}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">فصيلة الدم:</span>
                        <span class="info-value">${currentUser.bloodType}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">آخر دورة شهرية:</span>
                        <span class="info-value">${new Date(currentUser.lastPeriod).toLocaleDateString('ar-EG')}</span>
                    </div>
                </div>

                <div class="info-card">
                    <h3><i class="fas fa-history"></i> مواعيدك القادمة</h3>
                    <div id="patientAppointments" class="appointments-list">
                        <div class="loading-spinner">
                            <div class="spinner"></div>
                        </div>
                    </div>
                </div>
            `;

            // بدء الاستماع للإشعارات
            startNotificationsListener();
            
            // تحميل مواعيد المريض
            loadPatientAppointments();
        };

        // دالة عرض المواعيد السابقة في نافذة منبثقة
        window.showPreviousAppointments = async function() {
            if (!currentUser) return;
            
            // تحديث التنشيط في القائمة السفلية
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            document.querySelectorAll('.nav-item')[2].classList.add('active');
            
            // إخفاء لوحة الحجز إذا كانت مفتوحة
            hideBookingPanel();
            
            try {
                const dbRef = ref(database);
                const snapshot = await get(child(dbRef, `patientAppointments/${currentUser.fullName.replace(/\./g, '_')}`));
                
                const modal = document.getElementById('historyModal');
                const listDiv = document.getElementById('previousAppointmentsList');
                
                if (snapshot.exists()) {
                    const appointments = [];
                    snapshot.forEach((childSnapshot) => {
                        appointments.push({
                            id: childSnapshot.key,
                            ...childSnapshot.val()
                        });
                    });

                    // ترتيب المواعيد تنازلياً حسب التاريخ
                    appointments.sort((a, b) => new Date(b.date) - new Date(a.date));

                    if (appointments.length > 0) {
                        listDiv.innerHTML = appointments.map(apt => {
                            let statusText = '';
                            let statusClass = '';
                            
                            if (apt.status === 'confirmed') {
                                statusText = 'مؤكد';
                                statusClass = 'status-confirmed';
                            } else if (apt.status === 'completed') {
                                statusText = 'تمت المراجعة';
                                statusClass = 'status-completed';
                            } else {
                                statusText = 'قيد الانتظار';
                                statusClass = 'status-pending';
                            }

                            return `
                                <div class="appointment-item">
                                    <div class="appointment-date">
                                        <i class="fas fa-calendar"></i>
                                        ${new Date(apt.date).toLocaleDateString('ar-EG')}
                                    </div>
                                    <div class="appointment-time">
                                        <i class="fas fa-clock"></i>
                                        ${apt.time}
                                    </div>
                                    <div class="appointment-status ${statusClass}">
                                        ${statusText}
                                    </div>
                                </div>
                            `;
                        }).join('');
                    } else {
                        listDiv.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">لا توجد مواعيد سابقة</p>';
                    }
                } else {
                    listDiv.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">لا توجد مواعيد سابقة</p>';
                }
                
                modal.style.display = 'flex';
            } catch (error) {
                console.error('Error loading previous appointments:', error);
                showAlert('حدث خطأ في تحميل المواعيد السابقة', 'error');
            }
        };

        window.closeHistoryModal = function() {
            document.getElementById('historyModal').style.display = 'none';
            
            // إعادة تفعيل زر الرئيسية
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            document.querySelectorAll('.nav-item')[0].classList.add('active');
        };

        // دالة بدء الاستماع للإشعارات
        function startNotificationsListener() {
            if (!currentUser) return;
            
            const patientId = currentUser.fullName.replace(/\./g, '_');
            notificationsRef = ref(database, `patientNotifications/${patientId}`);
            
            notificationsListener = onValue(notificationsRef, (snapshot) => {
                const notifications = [];
                if (snapshot.exists()) {
                    snapshot.forEach((childSnapshot) => {
                        notifications.push({
                            id: childSnapshot.key,
                            ...childSnapshot.val()
                        });
                    });
                    
                    // ترتيب الإشعارات من الأحدث إلى الأقدم
                    notifications.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                    
                    // تحديث عداد الإشعارات
                    updateNotificationBadge(notifications);
                    
                    // عرض الإشعارات في اللوحة
                    displayNotifications(notifications);
                }
            });
        }

        // دالة تحديث عداد الإشعارات
        function updateNotificationBadge(notifications) {
            const unreadCount = notifications.filter(n => !n.read).length;
            const badge = document.getElementById('notificationCount');
            const bar = document.getElementById('notificationBar');
            
            if (unreadCount > 0) {
                badge.textContent = unreadCount;
                badge.style.display = 'inline-block';
                bar.style.background = '#ffc107';
                bar.style.color = '#000';
            } else {
                badge.style.display = 'none';
                bar.style.background = '#fff3cd';
                bar.style.color = '#856404';
            }
        }

        // دالة عرض الإشعارات
        function displayNotifications(notifications) {
            const panel = document.getElementById('notificationsPanel');
            
            if (notifications.length === 0) {
                panel.innerHTML = `
                    <div class="notification-item" style="justify-content: center;">
                        <p style="color: #666;">لا توجد إشعارات</p>
                    </div>
                `;
                return;
            }
            
            panel.innerHTML = notifications.map(notif => {
                const time = new Date(notif.timestamp).toLocaleString('ar-EG');
                let icon = 'fa-info-circle';
                let title = '';
                
                if (notif.type === 'booking_confirmed') {
                    icon = 'fa-check-circle';
                    title = 'تم تأكيد حجزك';
                } else if (notif.type === 'booking_pending') {
                    icon = 'fa-clock';
                    title = 'حجز قيد الانتظار';
                } else if (notif.type === 'appointment_completed') {
                    icon = 'fa-heart';
                    title = 'تمت المراجعة';
                } else if (notif.type === 'thank_you') {
                    icon = 'fa-smile';
                    title = 'شكراً لكم';
                }
                
                return `
                    <div class="notification-item ${notif.read ? '' : 'unread'}" onclick="markNotificationRead('${notif.id}')">
                        <div class="notification-icon">
                            <i class="fas ${icon}"></i>
                        </div>
                        <div class="notification-details">
                            <div class="notification-title">${title}</div>
                            <div class="notification-desc">${notif.message}</div>
                            <div class="notification-time">${time}</div>
                        </div>
                        ${!notif.read ? '<span class="status-badge status-pending">جديد</span>' : ''}
                    </div>
                `;
            }).join('');
        }

        // دالة تبديل عرض لوحة الإشعارات
        window.toggleNotifications = function() {
            const panel = document.getElementById('notificationsPanel');
            panel.classList.toggle('show');
        };

        // دالة تعليم الإشعار كمقروء
        window.markNotificationRead = async function(notificationId) {
            if (!currentUser) return;
            
            try {
                const patientId = currentUser.fullName.replace(/\./g, '_');
                await update(ref(database, `patientNotifications/${patientId}/${notificationId}`), {
                    read: true
                });
            } catch (error) {
                console.error('Error marking notification as read:', error);
            }
        };

        // دالة تحميل المواعيد المتاحة في لوحة الحجز
        window.loadAvailableAppointmentsPanel = async function() {
            try {
                const dbRef = ref(database);
                const snapshot = await get(child(dbRef, 'availableAppointments'));
                
                const appointmentsDiv = document.getElementById('availableAppointmentsPanel');
                
                if (snapshot.exists()) {
                    const appointments = [];
                    snapshot.forEach((childSnapshot) => {
                        appointments.push({
                            id: childSnapshot.key,
                            ...childSnapshot.val()
                        });
                    });

                    // ترتيب المواعيد حسب التاريخ
                    appointments.sort((a, b) => new Date(a.date) - new Date(a.date));

                    // التحقق من المواعيد المحجوزة من قبل هذا المريض
                    const patientAppointmentsSnapshot = await get(child(dbRef, `patientAppointments/${currentUser.fullName.replace(/\./g, '_')}`));
                    const patientBookings = [];
                    
                    if (patientAppointmentsSnapshot.exists()) {
                        patientAppointmentsSnapshot.forEach((childSnapshot) => {
                            patientBookings.push({
                                id: childSnapshot.key,
                                ...childSnapshot.val()
                            });
                        });
                    }

                    // الحصول على جميع الحجوزات لمعرفة المواعيد الممتلئة
                    const allBookingsSnapshot = await get(child(dbRef, 'bookings'));

                    if (appointments.length > 0) {
                        appointmentsDiv.innerHTML = appointments.map(apt => {
                            // التحقق من حجز المريض في هذا اليوم
                            const hasBookingToday = patientBookings.some(booking => 
                                booking.date === apt.date && 
                                (booking.status === 'pending' || booking.status === 'confirmed')
                            );

                            // التحقق من امتلاء الموعد
                            let isFull = false;
                            if (allBookingsSnapshot.exists() && allBookingsSnapshot.hasChild(apt.id)) {
                                let bookingCount = 0;
                                allBookingsSnapshot.child(apt.id).forEach(() => bookingCount++);
                                isFull = apt.maxBookings ? bookingCount >= apt.maxBookings : false;
                            }

                            // تحديد ما إذا كان الموعد متاحاً للحجز
                            const isBooked = hasBookingToday;
                            const isDisabled = isBooked || isFull;

                            let extraClass = '';
                            let title = '';
                            
                            if (isBooked) {
                                extraClass = 'booked';
                                title = 'لديك حجز في هذا اليوم بالفعل';
                            } else if (isFull) {
                                extraClass = 'full';
                                title = 'الموعد ممتلئ - غير متاح للحجز';
                            }

                            return `
                                <div class="appointment-slot ${isDisabled ? 'disabled ' + extraClass : ''}" 
                                     onclick="${!isDisabled ? `selectAppointmentPanel('${apt.id}', '${apt.date}', '${apt.time}')` : 'event.preventDefault()'}"
                                     title="${title}">
                                    <div class="slot-date">${new Date(apt.date).toLocaleDateString('ar-EG')}</div>
                                    <div class="slot-time">${apt.time}</div>
                                    ${isBooked ? '<div><small>محجوز</small></div>' : ''}
                                    ${isFull ? '<div class="full-label">ممتلئ</div>' : ''}
                                </div>
                            `;
                        }).join('');
                    } else {
                        appointmentsDiv.innerHTML = '<p style="text-align: center; color: #666;">لا توجد مواعيد متاحة حالياً</p>';
                    }
                } else {
                    appointmentsDiv.innerHTML = '<p style="text-align: center; color: #666;">لا توجد مواعيد متاحة حالياً</p>';
                }
            } catch (error) {
                console.error('Error loading appointments:', error);
                document.getElementById('availableAppointmentsPanel').innerHTML = '<p style="text-align: center; color: #dc3545;">حدث خطأ في تحميل المواعيد</p>';
            }
        };

        // دالة تحميل مواعيد المريض
        window.loadPatientAppointments = async function() {
            try {
                const dbRef = ref(database);
                const snapshot = await get(child(dbRef, `patientAppointments/${currentUser.fullName.replace(/\./g, '_')}`));
                
                const appointmentsDiv = document.getElementById('patientAppointments');
                
                if (snapshot.exists()) {
                    const appointments = [];
                    snapshot.forEach((childSnapshot) => {
                        appointments.push({
                            id: childSnapshot.key,
                            ...childSnapshot.val()
                        });
                    });

                    // ترتيب المواعيد حسب التاريخ (الأقرب أولاً)
                    appointments.sort((a, b) => new Date(a.date) - new Date(b.date));

                    // عرض فقط المواعيد القادمة (pending و confirmed)
                    const upcomingAppointments = appointments.filter(apt => 
                        apt.status === 'pending' || apt.status === 'confirmed'
                    );

                    if (upcomingAppointments.length > 0) {
                        appointmentsDiv.innerHTML = upcomingAppointments.map(apt => {
                            let statusText = '';
                            let statusClass = '';
                            
                            if (apt.status === 'confirmed') {
                                statusText = 'مؤكد';
                                statusClass = 'status-confirmed';
                            } else {
                                statusText = 'قيد الانتظار';
                                statusClass = 'status-pending';
                            }

                            return `
                                <div class="appointment-item">
                                    <div class="appointment-date">
                                        <i class="fas fa-calendar"></i>
                                        ${new Date(apt.date).toLocaleDateString('ar-EG')}
                                    </div>
                                    <div class="appointment-time">
                                        <i class="fas fa-clock"></i>
                                        ${apt.time}
                                    </div>
                                    <div class="appointment-status ${statusClass}">
                                        ${statusText}
                                    </div>
                                </div>
                            `;
                        }).join('');
                    } else {
                        appointmentsDiv.innerHTML = '<p style="text-align: center; color: #666;">لا توجد مواعيد قادمة</p>';
                    }
                } else {
                    appointmentsDiv.innerHTML = '<p style="text-align: center; color: #666;">لا توجد مواعيد قادمة</p>';
                }
            } catch (error) {
                console.error('Error loading patient appointments:', error);
                document.getElementById('patientAppointments').innerHTML = '<p style="text-align: center; color: #dc3545;">حدث خطأ في تحميل المواعيد</p>';
            }
        };

        // دالة اختيار موعد من لوحة الحجز
        window.selectAppointmentPanel = function(id, date, time) {
            // إزالة التحديد من جميع المواعيد
            document.querySelectorAll('#availableAppointmentsPanel .appointment-slot').forEach(slot => {
                slot.classList.remove('selected');
            });
            
            // تحديد الموعد الحالي
            event.currentTarget.classList.add('selected');
            
            selectedAppointment = { id, date, time };
        };

        // دالة تأكيد الحجز
        window.confirmBooking = async function() {
            if (!selectedAppointment) {
                showAlert('الرجاء اختيار موعد أولاً', 'error');
                return;
            }

            try {
                // التحقق مرة أخرى من عدم وجود حجز في نفس اليوم
                const dbRef = ref(database);
                const patientAppointmentsSnapshot = await get(child(dbRef, `patientAppointments/${currentUser.fullName.replace(/\./g, '_')}`));
                
                if (patientAppointmentsSnapshot.exists()) {
                    let hasBookingToday = false;
                    patientAppointmentsSnapshot.forEach((childSnapshot) => {
                        const apt = childSnapshot.val();
                        if (apt.date === selectedAppointment.date && 
                            (apt.status === 'pending' || apt.status === 'confirmed')) {
                            hasBookingToday = true;
                        }
                    });

                    if (hasBookingToday) {
                        showAlert('لا يمكنك حجز أكثر من موعد في نفس اليوم', 'error');
                        return;
                    }
                }

                // التحقق من امتلاء الموعد
                const appointmentSnapshot = await get(child(dbRef, `availableAppointments/${selectedAppointment.id}`));
                if (appointmentSnapshot.exists()) {
                    const appointment = appointmentSnapshot.val();
                    
                    // حساب عدد الحجوزات الحالية
                    const bookingsSnapshot = await get(child(dbRef, `bookings/${selectedAppointment.id}`));
                    let bookingCount = 0;
                    if (bookingsSnapshot.exists()) {
                        bookingsSnapshot.forEach(() => bookingCount++);
                    }
                    
                    if (appointment.maxBookings && bookingCount >= appointment.maxBookings) {
                        showAlert('عذراً، هذا الموعد ممتلئ', 'error');
                        return;
                    }
                }

                // حفظ الحجز في قاعدة البيانات
                const bookingId = Date.now().toString();
                const bookingRef = ref(database, `bookings/${selectedAppointment.id}/${bookingId}`);
                await set(bookingRef, {
                    patientName: currentUser.fullName,
                    patientId: currentUser.fullName.replace(/\./g, '_'),
                    date: selectedAppointment.date,
                    time: selectedAppointment.time,
                    bookingDate: new Date().toISOString(),
                    status: 'pending'
                });

                // حفظ في مواعيد المريض
                const patientAppointmentRef = ref(database, `patientAppointments/${currentUser.fullName.replace(/\./g, '_')}/${selectedAppointment.id}`);
                await set(patientAppointmentRef, {
                    date: selectedAppointment.date,
                    time: selectedAppointment.time,
                    status: 'pending'
                });

                // إضافة إشعار للمريض
                const notificationRef = ref(database, `patientNotifications/${currentUser.fullName.replace(/\./g, '_')}/${bookingId}`);
                await set(notificationRef, {
                    type: 'booking_pending',
                    message: `تم حجز موعد في ${new Date(selectedAppointment.date).toLocaleDateString('ar-EG')} الساعة ${selectedAppointment.time}`,
                    timestamp: new Date().toISOString(),
                    read: false
                });

                // إرسال إشعار للدكتورة
                const adminNotificationRef = ref(database, 'notifications');
                await push(adminNotificationRef, {
                    type: 'new_booking',
                    patientName: currentUser.fullName,
                    date: selectedAppointment.date,
                    time: selectedAppointment.time,
                    timestamp: new Date().toISOString(),
                    read: false
                });

                // إظهار رسالة تأكيد الحجز في الوسط
                showBookingConfirmMessage();
                
                // إخفاء لوحة الحجز
                hideBookingPanel();
                
                // إعادة تحميل مواعيد المريض
                loadPatientAppointments();
                
                // إلغاء التحديد
                selectedAppointment = null;
                
                // تحديث التنشيط في القائمة السفلية للرئيسية
                document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
                document.querySelectorAll('.nav-item')[0].classList.add('active');
            } catch (error) {
                console.error('Error booking appointment:', error);
                showAlert('حدث خطأ في حجز الموعد', 'error');
            }
        };

        // دالة تسجيل الخروج
        window.logout = function() {
            // تحديث التنشيط في القائمة السفلية
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            document.querySelectorAll('.nav-item')[3].classList.add('active');
            
            // إيقاف الاستماع للإشعارات
            if (notificationsListener) {
                off(notificationsRef);
            }
            
            currentUser = null;
            selectedAppointment = null;
            document.getElementById('notificationBar').style.display = 'none';
            document.getElementById('notificationsPanel').innerHTML = '';
            document.getElementById('bottomNav').style.display = 'none';
            document.getElementById('bookingPanel').classList.remove('show');
            document.getElementById('thankYouOverlay').style.display = 'none';
            document.getElementById('bookingConfirmOverlay').style.display = 'none';
            showLogin();
        };

        // إغلاق المودال عند الضغط خارج المحتوى
        window.onclick = function(event) {
            const modal = document.getElementById('historyModal');
            if (event.target === modal) {
                modal.style.display = 'none';
                
                // إعادة تفعيل زر الرئيسية
                document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
                document.querySelectorAll('.nav-item')[0].classList.add('active');
            }
            
            // إغلاق لوحة الحجز عند الضغط خارجها
            const bookingPanel = document.getElementById('bookingPanel');
            if (event.target === bookingPanel) {
                bookingPanel.classList.remove('show');
                
                // إعادة تفعيل زر الرئيسية
                document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
                document.querySelectorAll('.nav-item')[0].classList.add('active');
            }
        };
    </script>
</body>
</html>
